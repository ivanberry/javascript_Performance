# 风车理财性能分析报告

## 测试环境

OS：Chrome模拟
network: 4G

**TL:DR**

- 资源层
	- 利用构建工具
	- 自动化
- 语法层
	- 遵循语法的最佳实践

**总论**：
传输层面的从来都是优化的核心点，而这个层面的优化要对浏览器有一个基本的认识，比如：

① 网页自上而下的解析渲染，边解析边渲染，页面内CSS文件会阻塞渲染，异步CSS文件会导致回流
② 浏览器在document下载结束会检测静态资源，新开线程下载（有并发上限），在带宽限制的条件下，无序并发会导致主资源速度下降，从而影响首屏渲染
③ 浏览器缓存可用时会使用缓存资源，这个时候可以避免请求体的传输，对性能有极大提高
衡量性能的重要指标为首屏载入速度（指页面可以看见，不一定可交互），影响首屏的最大因素为请求，所以请求是页面真正的杀手，一般来说我们会做这些优化：

减少请求数
① 合并样式、脚本文件
② 合并背景图片
③ CSS3图标、Icon Font

降低请求量
① 开启GZip
② 优化静态资源，jQuery->Zepto、阉割IScroll、去除冗余代码
③ 图片无损压缩
④ 图片延迟加载

很多时候，也会采用类似“时间换空间、空间换时间”的做法，比如：

① 缓存为王，对更新较缓慢的资源&接口做缓存（浏览器缓存、localsorage）
② 按需加载，先加载主要资源，其余资源延迟加载，对非首屏资源滚动加载

## 资源层
类库或库引入的必要性探究：

移动端网络传输开销非常昂贵，所以对于使用度不高的库的引入，需要慎重。

实例1：css动画库**animation.css**的引入，使用度：10%

**network**：
![animation.css](https://ooo.0o0.ooo/2016/08/21/57ba5fdfb1d95.png)

timeline载入分析：
![animatin-timeline](https://ooo.0o0.ooo/2016/08/21/57ba607320f33.png)

~~动画库的使用程度低（暂时只在loading时发现利用）~~，后来发现，loading图也**没有**利用这个动画类库。那么这个库的引入就是个问题，大小56kb，影响对首屏UI输出。那么它存在的必要性就非常非常低。

实例2：特性检测库Modernizr

查看animation过程中发现Modernizr的存在，使用率也相当低，仅仅对animation有探测，对于css**prefix**的使用我们可以：

1. 工具自动化
2. caniuse兼容性查询

![caniuse](https://ooo.0o0.ooo/2016/08/21/57ba64d3215d5.png)

*问题*:
1. 首屏输出延迟，白屏
2. 切换页面卡顿，白屏

*解决*：
1. 资源的加载以首屏输出为要点，优先加载,对首屏展示可采用内联CSS等方式
2. 图片懒加载，按需加载


## 结构
应用整体结构较为简单，为模拟的单页面应用，目录结构如下：

![structure.PNG](https://ooo.0o0.ooo/2016/08/15/57b29cd27cfec.png)

随着项目的成长，最好是有完整的目录结构，利于维护，利于模块管理。甚至利用成熟的框架来实现功能

## 资源
**问题：**
任何网站或者webapp都话费80%~90%的时间在资源的下载中！
首页资源加载时间： 请求数目：70，资源请求至返回：1050ms,页面完整输出： 1180ms.
计算值，首页请求时间占用过高。


![request.png](https://ooo.0o0.ooo/2016/08/15/57b29cd269b44.png)

![request_2.PNG](https://ooo.0o0.ooo/2016/08/15/57b29cd279fa3.png)

**方法:**
**minify, 打包，CDN发布（图片服务器)**

前端的构建工具能在这方面提供许多的工程化，自动化，所以我们需要一个特别的流程来开发，并区分**开发**模式和**发布**模式

## 路由方法

**问题:**
路由跳转是通过`goUrl`,通过监听URL hash值实现切换，分屏页面通过JS组合模板和JSON数据,插入页面DOM结构中，DOM的操作
开销对性能有非常大的影响!下图展示类页面切换过程中**卡顿**来由：

## 具体问题

1. 根据Javascript最佳实践重写瓶颈方法，尤其是页面切换需要调用的方法

语法最佳实践：
        - 全局变量噩梦
        - DOM节点缓存
        - 避免使用with eval等语法
        - 避免对样式的直接操作，使用类名修改样式
        - ......

优化痛点在于：避免对于DOM的操作,*app.js*中的`setTitle`

2. 投资页面到发现页面

页面跳转不是这次切换的瓶颈所在，反而是图表渲染，不管是**echart**,还是**highchart**，我们可以通过推测用户行为来实现按需加载，比如点击查看图表详情来渲染图表，这样就可以从另一种角度来实现*切换卡顿*消除。

3. 预处理

页面中有许多资源需要加载，我们可以预见性的先让浏览器知道之后我们可能会要加载的资源，这给我们开发者一定程度上有优化的可能。

- DNS prefetch
- resource prefetch
```html
<link rel="prefetch" href=url>
```

运用实例 一： 

问题： 
    1. 为什么动画旋转在4G情况下会出现先黑色框再会有风车标志呢？
    
    因为Javascript加载会阻塞其他资源（css, img etc)，在完成其他加载之前，其他资源不会加载，而在加载我们风车标志的*fonticon*前，有好几个js资源加载，它基本处于第十个加载的资源，理所当然会出现黑框情况，严重影响用户体验。
    
    2. 为什么首屏出现时会出现头部banner图闪现，页面跳动呢？
    
    理由同上，banner图相对较大，后插入页面中。
    
解决：

```html
    <link rel="prefetch" href="/hybrid/fclc2/res/webfont/fontello.ttf?v=10">
    <link rel="prefetch" href="/hybrid/fclc2/res/img/index/banner_2_3.png">
```

通过调试工具我们很容易发现，对这两个首屏需要的资源，我们请求优先提高至*index.html*之前了。

当然，上面的方法不是适用于任何情况，需具体分析，就上例，我们的banner图相对较大，加载时间较长，就会影响我们css的加载，那又如何优化呢？

运用实例二：

问题： 
**发现页面**切换卡顿：

投资组合中，我们没有必要再切换过程是实例化6个饼图，假如用户根本不会进入其他TAB中，那我们消耗的资源就显得毫无意义，所以，我们应该基于用户（统计数据）行为分析。

![bottleneck.PNG](https://ooo.0o0.ooo/2016/08/15/57b29cd25f62c.png)





--**EOF**--